<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>K230 - AIäº‹ä»¶å®æ—¶ç›‘æ§ä¸æ§åˆ¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background:
            linear-gradient(rgba(10, 25, 50, 0.6), rgba(10, 25, 50, 0.6)),
            url('https://i-blog.csdnimg.cn/blog_migrate/3c91527f678ce3658ea505f41356ea71.png') no-repeat center center fixed;
        background-size: cover;
        color: #eee;
        min-height: 100vh;
    }
    .status-card:hover, .sensor-card:hover, .log-card:hover {
        transform: scale(1.02);
        box-shadow: 0 0 25px rgba(255, 255, 255, 0.15);
    }
    .log-empty {
        height: 100%; display: flex; justify-content: center; align-items: center;
    }
    #face-log-list::-webkit-scrollbar,
    #record-log-list::-webkit-scrollbar,
    #message-log::-webkit-scrollbar {
        width: 6px;
    }
    #face-log-list::-webkit-scrollbar-thumb,
    #record-log-list::-webkit-scrollbar-thumb,
    #message-log::-webkit-scrollbar-thumb {
        background-color: rgba(255,255,255,0.3);
        border-radius: 3px;
    }
    </style>
</head>
<body class="text-white p-4 flex flex-col items-center">
    <div class="w-full max-w-7xl">
        <header class="text-center mb-4">
            <h1 class="text-3xl font-bold text-cyan-400">K230 å®æ—¶AIäº‹ä»¶ç›‘æ§ä¸æ§åˆ¶</h1>
            <p id="connection-status" class="mt-1 text-sm text-yellow-400">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</p>
            <div class="mt-2 flex justify-center items-center gap-4">
                <p id="device-mode-status" class="text-sm text-gray-300">å½“å‰è®¾å¤‡æ¨¡å¼: <span class="font-bold">è®¿å®¢æ¨¡å¼</span></p>
                <button id="mode-switch-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded-lg shadow-md transition-all duration-200">
                    è¿›å…¥æ³¨å†Œæ¨¡å¼
                </button>
            </div>
        </header>

        <div id="status-card" class="status-card bg-gray-800 rounded-xl shadow-xl p-4 mb-10 text-sm flex flex-col justify-center items-center h-36">
            <h2 class="text-base font-semibold text-gray-400 mb-1 self-start">å½“å‰AIçŠ¶æ€</h2>
            <p id="current-status-text" class="text-2xl font-bold text-gray-200 text-center">- ç­‰å¾…æ•°æ® -</p>
            <p id="last-update" class="text-xs text-gray-500 self-end mt-1">æœ€åæ›´æ–°: N/A</p>
        </div>

        <div class="flex flex-col md:flex-row gap-3 mb-10">
            <!-- æ¸©æ¹¿åº¦å¡ç‰‡ -->
            <div class="sensor-card flex-1 bg-gradient-to-br from-blue-500 to-green-500 rounded-xl p-3 flex flex-col justify-center items-center h-36 text-sm">
                <h2 class="font-semibold self-start mb-1 w-full">ğŸŒ³ ç¯å¢ƒæ¸©æ¹¿åº¦</h2>
                <div class="text-center">
                    <div class="text-3xl">ğŸŒ¡ï¸ğŸ’§</div>
                    <p class="mt-1">æ¸©åº¦: <span id="temp-value">--</span> Â°C</p>
                    <p class="mt-1">æ¹¿åº¦: <span id="humi-value">--</span> %RH</p>
                </div>
                <p id="sensor-update" class="text-xs self-end mt-auto w-full text-right">æœ€åæ›´æ–°: N/A</p>
            </div>
            <!-- å‡ºå…¥äººå‘˜è®°å½•å¡ç‰‡ -->
            <div class="log-card flex-1 bg-gradient-to-br from-purple-600 via-pink-600 to-red-600 rounded-xl p-3 flex flex-col h-36 text-sm relative">
                <h2 class="font-semibold mb-1">ğŸ‘¤ å‡ºå…¥äººå‘˜è®°å½•</h2>
                <div id="face-log-list" class="space-y-1 max-h-24 overflow-y-auto pr-1 text-xs">
                    <div class="log-empty text-gray-300 select-none">æš‚æ— è®°å½•</div>
                </div>
                <p id="face-update" class="text-xs self-end mt-auto w-full text-right">æœ€åæ›´æ–°: N/A</p>
            </div>
            <!-- å½•éŸ³ç•™è¨€è®°å½•å¡ç‰‡ -->
            <div class="log-card flex-1 bg-gradient-to-br from-yellow-600 via-amber-600 to-orange-600 rounded-xl p-3 flex flex-col justify-center h-36 text-sm relative">
                <h2 class="font-semibold mb-1">ğŸ“» å½•éŸ³ç•™è¨€è®°å½•</h2>
                <div id="record-log-list" class="space-y-1 max-h-24 overflow-y-auto pr-1 text-xs">
                    <div class="log-empty text-gray-300 select-none">æš‚æ— è®°å½•</div>
                </div>
                <p id="record-update" class="text-xs self-end mt-auto w-full text-right">æœ€åæ›´æ–°: N/A</p>
            </div>
        </div>

        <footer class="log-card rounded-xl p-4 w-full text-sm bg-[#1e1b3a] border border-blue-500/40 shadow-[0_0_15px_rgba(59,130,246,0.4)]">
            <div class="flex items-center justify-between mb-2">
                <h3 class="font-semibold text-base">å†å²äº‹ä»¶æ—¥å¿—</h3>
                <div class="flex items-center gap-3">
                    <button id="location-switch-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-sm px-3 py-1 rounded-lg shadow-md transition-all duration-200">
                        åœ°ç‚¹ä¸€
                    </button>
                    <button id="dispatch-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-3 py-1 rounded-lg shadow-md transition-all duration-200">
                        å‡ºåŠ¨å°è½¦
                    </button>
                </div>
            </div>
            <div id="message-log" class="space-y-2 h-48 overflow-y-auto pr-1 text-xs">
                <p class="text-gray-500 select-none">æš‚æ— å†å²è®°å½•</p>
            </div>
            <p id="command-feedback" class="text-xs mt-2 h-4 text-center"></p>
        </footer>
    </div>
    <button id="clear-screen-btn" title="ç½‘é¡µæ¸…å±" class="fixed bottom-6 right-6 z-50 bg-gray-600 hover:bg-gray-700 text-white text-2xl w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-transform transform hover:scale-110">
        ğŸ§¹
    </button>
<script>
    // --- MQTT é…ç½® ---
    const MQTT_BROKER_HOST = 'broker.emqx.io';
    const MQTT_BROKER_PORT = 8084; // WebSocket Secure ç«¯å£
    const MQTT_STATUS_TOPIC = 'k230/ai/status_feed';
    const MQTT_COMMAND_TOPIC = 'k230/ai/command';
    const MQTT_CLIENT_ID = 'web_monitor_ctrl_' + Math.random().toString(16).substr(2, 8);

    // --- UIå…ƒç´  ---
    const connectionStatusElem = document.getElementById('connection-status');
    const statusCardElem = document.getElementById('status-card');
    const currentStatusTextElem = document.getElementById('current-status-text');
    const lastUpdateElem = document.getElementById('last-update');
    const messageLogElem = document.getElementById('message-log');
    const dispatchBtn = document.getElementById('dispatch-btn');
    const commandFeedbackElem = document.getElementById('command-feedback');
    const clearScreenBtn = document.getElementById('clear-screen-btn');
    const locationSwitchBtn = document.getElementById('location-switch-btn');
    const modeSwitchBtn = document.getElementById('mode-switch-btn');
    const deviceModeStatusElem = document.getElementById('device-mode-status').querySelector('span');
    const faceLogListElem = document.getElementById('face-log-list');
    const faceUpdateElem = document.getElementById('face-update');
    /* âœï¸ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä»£ç  */
    const tempValueElem = document.getElementById('temp-value');
    const humiValueElem = document.getElementById('humi-value');
    const sensorUpdateElem = document.getElementById('sensor-update');

    /* --- æ–°å¢: å½•éŸ³è®°å½•UIå…ƒç´  --- */
    const recordLogListElem = document.getElementById('record-log-list');
    const recordUpdateElem = document.getElementById('record-update');


    // --- çŠ¶æ€å˜é‡ ---
    const locations = [{ name: 'åœ°ç‚¹ä¸€', value: 1 }, { name: 'åœ°ç‚¹äºŒ', value: 2 }, { name: 'åœ°ç‚¹ä¸‰', value: 3 }];
    let currentLocationIndex = 0;
    let statusResetTimeout = null;
    let isRegisterMode = false;

    /* âœï¸ æ–°å¢: å®šä¹‰é«˜æ¸©è­¦æŠ¥é˜ˆå€¼ (å•ä½: Â°C) */
    const TEMP_HIGH_THRESHOLD = 40.0;

    // --- çŠ¶æ€ç æ˜ å°„è¡¨ ---
    const STATUS_MAP = {
                /* âœï¸ æ–°å¢: è‡ªåŠ¨å‡ºåŠ¨æŒ‡ä»¤çŠ¶æ€ç  */
        '0x01': { text: "è‡ªåŠ¨æŒ‡ä»¤: å‡ºåŠ¨å°è½¦(åœ°ç‚¹ä¸€)", color: "bg-cyan-700", icon: 'ğŸ¤–' },
        '0x02': { text: "è‡ªåŠ¨æŒ‡ä»¤: å‡ºåŠ¨å°è½¦(åœ°ç‚¹äºŒ)", color: "bg-cyan-700", icon: 'ğŸ¤–' },
        '0x03': { text: "è‡ªåŠ¨æŒ‡ä»¤: å‡ºåŠ¨å°è½¦(åœ°ç‚¹ä¸‰)", color: "bg-cyan-700", icon: 'ğŸ¤–' },
        '0x10': { text: "ä¸€åˆ‡æ­£å¸¸", color: "bg-green-700", icon: 'âœ…' },
        '0x11': { text: "æ£€æµ‹åˆ°æœ‰äºº", color: "bg-blue-600", icon: 'ğŸ‘€' },
        '0x12': { text: "æ£€æµ‹åˆ°è·Œå€’", color: "bg-red-700", icon: 'ğŸ¤¸' },
        '0x13': { text: "æ£€æµ‹åˆ°å¸çƒŸ", color: "bg-orange-600", icon: 'ğŸš¬' },
        '0x14': { text: "æ£€æµ‹åˆ°é¦™çƒŸæˆ–æ‰“ç«æœº", color: "bg-orange-400", icon: 'ğŸš¬ğŸ”¥' },
        '0x21': { text: "è¯†åˆ«åˆ°æˆæƒäººå‘˜", color: "bg-purple-600", icon: 'ğŸ‘¤' },
        '0x22': { text: "æ£€æµ‹åˆ°æœªæˆæƒäººå‘˜", color: "bg-yellow-600", icon: 'âš ï¸' },
        '0xa0': { text: "è¿œç¨‹æŒ‡ä»¤ï¼šå‡ºåŠ¨å°è½¦", color: "bg-indigo-700", icon: 'ğŸš€' },
        /* âœï¸ åœ¨è¿™é‡Œæ·»åŠ ä¸‹é¢çš„ä¸‰è¡Œä»£ç  */
        '0x31': { text: "ç¡®è®¤ï¼šå°è½¦å·²å‡ºåŠ¨å‰å¾€åœ°ç‚¹ä¸€", color: "bg-teal-600", icon: 'âœ…' },
        '0x32': { text: "ç¡®è®¤ï¼šå°è½¦å·²å‡ºåŠ¨å‰å¾€åœ°ç‚¹äºŒ", color: "bg-teal-600", icon: 'âœ…' },
        '0x33': { text: "ç¡®è®¤ï¼šå°è½¦å·²å‡ºåŠ¨å‰å¾€åœ°ç‚¹ä¸‰", color: "bg-teal-600", icon: 'âœ…' },

        /* âœï¸ æ–°å¢: ä¸ºå‰ç«¯å®šä¹‰ä¸€ä¸ªé«˜æ¸©è­¦æŠ¥çš„ä¸“å±çŠ¶æ€ç  */
        '0xFE01': { text: "é«˜æ¸©è­¦æŠ¥ï¼", color: "bg-red-800", icon: 'ğŸ”¥' },
    };

    // --- MQTT å®¢æˆ·ç«¯åˆå§‹åŒ– ---
    const client = new Paho.Client(MQTT_BROKER_HOST, MQTT_BROKER_PORT, '/mqtt', MQTT_CLIENT_ID);
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    function onConnect() {
        console.log("æˆåŠŸè¿æ¥åˆ° MQTT Broker!");
        connectionStatusElem.textContent = "å·²è¿æ¥åˆ°æœåŠ¡å™¨";
        connectionStatusElem.className = "mt-1 text-sm text-green-400";
        client.subscribe(MQTT_STATUS_TOPIC);
        console.log("å·²è®¢é˜…ä¸»é¢˜:", MQTT_STATUS_TOPIC);
    }

    function onConnectionLost(responseObject) {
        console.log("MQTT è¿æ¥ä¸¢å¤±: ", responseObject.errorMessage);
        connectionStatusElem.textContent = "è¿æ¥ä¸¢å¤±ï¼Œæ­£åœ¨å°è¯•é‡è¿...";
        connectionStatusElem.className = "mt-1 text-sm text-red-400";
    }

    function onFailure(error) {
        console.error("MQTT è¿æ¥å¤±è´¥: ", error);
        connectionStatusElem.textContent = "è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ";
        connectionStatusElem.className = "mt-1 text-sm text-red-400";
    }

    /**
     * ğŸ†• æ ¸å¿ƒå‡½æ•°é‡æ„ï¼šæ ¹æ®äº‹ä»¶ç±»å‹ï¼Œå°†æ—¥å¿—åˆ†å‘åˆ°ä¸åŒçš„UIåŒºåŸŸ
     */
    function onMessageArrived(message) {

        // æ£€æŸ¥æ˜¯å¦ä¸ºå•å­—èŠ‚çš„äºŒè¿›åˆ¶å½•éŸ³æ¶ˆæ¯
        if (message.payloadBytes.length === 1) {
            const recordingIndex = message.payloadBytes[0];
            console.log(`æ”¶åˆ°äºŒè¿›åˆ¶å½•éŸ³æ¶ˆæ¯, ç´¢å¼•: ${recordingIndex}`);
            addRecordingLogEntry(recordingIndex);
            return; // å½•éŸ³æ¶ˆæ¯å¤„ç†å®Œæ¯•ï¼Œé€€å‡ºå‡½æ•°
        }

        try {
            const data = JSON.parse(message.payloadString);
            console.log("æ”¶åˆ°JSONæ¶ˆæ¯:", data);
           
           
            // ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦ä¸ºæ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨æ•°æ®
            if (data.hasOwnProperty('temperature') && data.hasOwnProperty('humidity')) {
                updateSensorCard(data);
                // ä¼ æ„Ÿå™¨æ•°æ®å¤„ç†å®Œæ¯•ï¼Œç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œåç»­çš„AIäº‹ä»¶é€»è¾‘
                return;
            }


            // 1. ä»»ä½•äº‹ä»¶éƒ½å…ˆæ›´æ–°ä¸»çŠ¶æ€å¡
            updateStatusCard(data);

            const statusCode = data.status_code;

            // 2. æ ¹æ®çŠ¶æ€ç å†³å®šæ—¥å¿—è®°å½•çš„ä½ç½®
            if (statusCode === '0x21') {
                // æˆæƒäººå‘˜ -> è®°å½•åˆ°â€œå‡ºå…¥äººå‘˜è®°å½•â€
                addAccessLogEntry(data.user_name, true);
            } else if (statusCode === '0x22') {
                // æœªæˆæƒäººå‘˜ -> è®°å½•åˆ°â€œå‡ºå…¥äººå‘˜è®°å½•â€
                addAccessLogEntry('æœªæˆæƒäººå‘˜', false);
            } else if (data.event_type === 'mode_change') {
                // æ¨¡å¼åˆ‡æ¢äº‹ä»¶ï¼Œåªå¤„ç†UIï¼Œä¸è®°å½•åˆ°æ—¥å¿—
                handleModeChange(data.mode);
            } else {
                // å…¶ä»–æ‰€æœ‰äº‹ä»¶ -> è®°å½•åˆ°â€œå†å²äº‹ä»¶æ—¥å¿—â€
                addLogEntry(data);
            }
        } catch (e) {
            console.error(`æ— æ³•è§£ææ¶ˆæ¯: `, e, `åŸå§‹æ¶ˆæ¯: ${message.payloadString}`);
        }
    }
    
    /* --- æ–°å¢: å¤„ç†å½•éŸ³è®°å½•çš„å‡½æ•° --- */
    function addRecordingLogEntry(index) {
        const placeholder = recordLogListElem.querySelector('.log-empty');
        if (placeholder) {
            recordLogListElem.innerHTML = '';
        }

        const logItem = document.createElement('div');
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        let logText;
        let icon;

        // æ ¹æ®K230ç«¯ä»£ç å®šä¹‰çš„äºŒè¿›åˆ¶ç è¿›è¡Œç¿»è¯‘
        if (index === 0) {
            logText = "å½•éŸ³å¤±è´¥";
            icon = 'âŒ';
        } else if (index === 254) { // 0xFE
            logText = "ç•™è¨€ç´¢å¼•è¿‡å¤§";
            icon = 'âš ï¸';
        } else if (index === 255) { // 0xFF
            logText = "æ— æ³•è¯†åˆ«çš„ç•™è¨€";
            icon = 'â“';
        } else {
            logText = `ç•™è¨€ ${index} å·²ä¿å­˜`;
            icon = 'ğŸ¤';
        }

        logItem.className = 'flex justify-between items-center p-1 bg-white/10 rounded';
        logItem.innerHTML = `
            <span>
                <span class="inline-block w-5 text-center">${icon}</span>
                ${logText}
            </span>
            <span class="text-gray-400">${timestamp}</span>
        `;

        recordLogListElem.prepend(logItem);

        while (recordLogListElem.children.length > 5) {
            recordLogListElem.lastElementChild.remove();
        }

        recordUpdateElem.textContent = `æœ€åæ›´æ–°: ${timestamp}`;
    }

    /* âœï¸ ä¿®æ”¹: é‡æ„æ­¤å‡½æ•°ä»¥é›†æˆæ¸©åº¦æ£€æŸ¥å’Œè­¦æŠ¥é€»è¾‘ */
    /**
     * æ›´æ–°ç¯å¢ƒæ¸©æ¹¿åº¦å¡ç‰‡ï¼Œå¹¶æ£€æŸ¥æ¸©åº¦æ˜¯å¦å¼‚å¸¸
     */
    function updateSensorCard(data) {
        const temp = data.temperature !== undefined ? parseFloat(data.temperature) : null;
        const humi = data.humidity !== undefined ? data.humidity : null;
        
        // 1. æ›´æ–°UIä¸Šçš„æ–‡æœ¬æ•°å€¼
        if (temp !== null) {
            tempValueElem.textContent = temp.toFixed(1); // ä¿ç•™ä¸€ä½å°æ•°
        }
        if (humi !== null) {
            humiValueElem.textContent = humi;
        }
        sensorUpdateElem.textContent = `æœ€åæ›´æ–°: ${new Date().toLocaleTimeString()}`;

        // 2. æ£€æŸ¥æ¸©åº¦æ˜¯å¦è¶…è¿‡é˜ˆå€¼
        const sensorCardElem = document.querySelector('.sensor-card'); // è·å–æ¸©æ¹¿åº¦å¡ç‰‡å…ƒç´ 
        if (temp !== null && temp >= TEMP_HIGH_THRESHOLD) {
            // --- æ¸©åº¦è¿‡é«˜ï¼Œè§¦å‘è­¦æŠ¥ ---
            // a) å°†æ¸©æ¹¿åº¦å¡ç‰‡å˜ä¸ºè­¦ç¤ºæ€§çš„çº¢æ©™è‰²æ¸å˜
            sensorCardElem.classList.remove('from-blue-500', 'to-green-500');
            sensorCardElem.classList.add('from-red-600', 'to-orange-600');
            
            // b) æ›´æ–°ä¸»çŠ¶æ€å¡ï¼Œæ˜¾ç¤ºé«˜æ¸©è­¦æŠ¥
            //    æˆ‘ä»¬å¤ç”¨ updateStatusCard å‡½æ•°ï¼Œå¹¶ä¼ å…¥è™šæ‹ŸçŠ¶æ€ç å’Œè¯¦ç»†æ¸©åº¦
            const alertData = {
                status_code: '0xFE01',
                user_name: `å½“å‰æ¸©åº¦: ${temp.toFixed(1)}Â°C` // ä½¿ç”¨ user_name å­—æ®µä¼ é€’è¯¦ç»†ä¿¡æ¯
            };
            updateStatusCard(alertData);
            
            // c) åœ¨å†å²äº‹ä»¶æ—¥å¿—ä¸­æ·»åŠ ä¸€æ¡è®°å½•
            addLogEntry({ status_code: '0xFE01' });

        } else {
            // --- æ¸©åº¦æ­£å¸¸ï¼Œæ¢å¤å¡ç‰‡é»˜è®¤æ ·å¼ ---
            sensorCardElem.classList.add('from-blue-500', 'to-green-500');
            sensorCardElem.classList.remove('from-red-600', 'to-orange-600');
        }
    }
    function updateStatusCard(data) {
        if (!data.status_code) return;
        if (statusResetTimeout) {
            clearTimeout(statusResetTimeout);
            statusResetTimeout = null;
        }

        const statusCode = data.status_code;
        const statusInfo = STATUS_MAP[statusCode];

        if (statusInfo) {
            let statusText = statusInfo.text;
            if (statusCode === '0x21' && data.user_name) {
                statusText += `: ${data.user_name}`;
            }
            currentStatusTextElem.textContent = statusText;
            statusCardElem.className = `status-card rounded-xl shadow-xl p-4 mb-10 text-sm flex flex-col justify-center items-center h-36 ${statusInfo.color}`;
        } else {
            currentStatusTextElem.textContent = `æœªçŸ¥çŠ¶æ€ (${statusCode})`;
            statusCardElem.className = "status-card bg-gray-800 rounded-xl shadow-xl p-4 mb-10 text-sm flex flex-col justify-center items-center h-36";
        }
        lastUpdateElem.textContent = `æœ€åæ›´æ–°: ${new Date().toLocaleTimeString()}`;
    }

    /**
     * å°†éäººè„¸è¯†åˆ«äº‹ä»¶æ·»åŠ åˆ°â€œå†å²äº‹ä»¶æ—¥å¿—â€
     */
    function addLogEntry(data) {
        const statusCode = data.status_code;
        if (!STATUS_MAP[statusCode]) return;
        
        const placeholder = messageLogElem.querySelector('p');
        if (placeholder) messageLogElem.innerHTML = '';
        
        const statusInfo = STATUS_MAP[statusCode];
        const logText = statusInfo.text;
        const icon = statusInfo.icon || 'ğŸ””';
        const timestamp = new Date().toLocaleTimeString();
        const logItem = document.createElement('div');
        const logColor = statusInfo.color ? statusInfo.color.replace('bg-', 'bg-opacity-30 bg-') : 'bg-gray-700';
        
        logItem.className = `${logColor} p-2 rounded-lg flex justify-between items-center`;
        logItem.innerHTML = `<span><span class="inline-block text-center w-6">${icon}</span>${logText}</span><span class="text-gray-400">${timestamp}</span>`;
        
        messageLogElem.prepend(logItem);
        while (messageLogElem.children.length > 20) {
            messageLogElem.lastElementChild.remove();
        }
    }

    /**
     * ğŸ†• æ–°å¢å‡½æ•°ï¼šå¤„ç†æ‰€æœ‰å‡ºå…¥è®°å½•ï¼ˆæˆæƒå’Œæœªæˆæƒï¼‰ï¼Œæ›´æ–°â€œå‡ºå…¥äººå‘˜è®°å½•â€å¡ç‰‡
     * @param {string} name - äººå‘˜åç§°æˆ–"æœªæˆæƒäººå‘˜"
     * @param {boolean} isAuthorized - trueä»£è¡¨æˆæƒ, falseä»£è¡¨æœªæˆæƒ
     */
    function addAccessLogEntry(name, isAuthorized) {
        const placeholder = faceLogListElem.querySelector('.log-empty');
        if (placeholder) {
            faceLogListElem.innerHTML = '';
        }
        
        const logItem = document.createElement('div');
        const nameColor = isAuthorized ? 'text-cyan-300' : 'text-red-400';
        const icon = isAuthorized ? 'âœ”ï¸' : 'âŒ';
        logItem.className = 'flex justify-between items-center p-1 bg-white/10 rounded';
        
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        
        logItem.innerHTML = `
            <span class="font-semibold ${nameColor}">
                <span class="inline-block w-5 text-center">${icon}</span>
                ${name}
            </span>
            <span class="text-gray-400">${timestamp}</span>
        `;
        
        faceLogListElem.prepend(logItem);
        
        while (faceLogListElem.children.length > 5) {
            faceLogListElem.lastElementChild.remove();
        }
        
        faceUpdateElem.textContent = `æœ€åæ›´æ–°: ${timestamp}`;
    }

    function handleModeChange(mode) {
        console.log(`æ”¶åˆ°è®¾å¤‡æ¨¡å¼å˜æ›´ç¡®è®¤: ${mode}`);
        if (mode === 'registration') {
            isRegisterMode = true;
            deviceModeStatusElem.textContent = 'æ³¨å†Œæ¨¡å¼';
            modeSwitchBtn.textContent = 'è¿”å›è®¿å®¢æ¨¡å¼';
            showFeedback('è®¾å¤‡å·²è¿›å…¥æ³¨å†Œæ¨¡å¼', false);
        } else { // visitor
            isRegisterMode = false;
            deviceModeStatusElem.textContent = 'è®¿å®¢æ¨¡å¼';
            modeSwitchBtn.textContent = 'è¿›å…¥æ³¨å†Œæ¨¡å¼';
            showFeedback('è®¾å¤‡å·²è¿”å›è®¿å®¢æ¨¡å¼', false);
        }
    }

    function toggleDeviceMode() {
        if (!client.isConnected()) {
            showFeedback("é”™è¯¯ï¼šæœªè¿æ¥åˆ°æœåŠ¡å™¨", true);
            return;
        }
        const command = isRegisterMode ? 'exit_registration_mode' : 'enter_registration_mode';
        const payload = { command: command };
        const message = new Paho.Message(JSON.stringify(payload));
        message.destinationName = MQTT_COMMAND_TOPIC;
        client.send(message);
        showFeedback('æ¨¡å¼åˆ‡æ¢æŒ‡ä»¤å·²å‘é€ï¼Œç­‰å¾…è®¾å¤‡ç¡®è®¤...', false);
    }

    function showFeedback(text, isError) {
        commandFeedbackElem.textContent = text;
        commandFeedbackElem.className = isError ? 'text-center text-xs mt-2 h-4 text-red-400' : 'text-center text-xs mt-2 h-4 text-green-400';
        if (!isError) {
            setTimeout(() => { commandFeedbackElem.textContent = ''; }, 4000);
        }
    }

    function resetUI() {
        currentStatusTextElem.textContent = "- ç­‰å¾…æ•°æ® -";
        lastUpdateElem.textContent = "æœ€åæ›´æ–°: N/A";
        statusCardElem.className = "status-card bg-gray-800 rounded-xl shadow-xl p-4 mb-10 text-sm flex flex-col justify-center items-center h-36";
        messageLogElem.innerHTML = '<p class="text-gray-500 select-none">æš‚æ— å†å²è®°å½•</p>';
        faceLogListElem.innerHTML = '<div class="log-empty text-gray-300 select-none">æš‚æ— è®°å½•</div>';
        faceUpdateElem.textContent = "æœ€åæ›´æ–°: N/A";
        commandFeedbackElem.textContent = '';
        tempValueElem.textContent = '--';
        humiValueElem.textContent = '--';
        sensorUpdateElem.textContent = "æœ€åæ›´æ–°: N/A";
        recordLogListElem.innerHTML = '<div class="log-empty text-gray-300 select-none">æš‚æ— è®°å½•</div>';
        recordUpdateElem.textContent = "æœ€åæ›´æ–°: N/A";
        /* âœï¸ æ–°å¢: ç¡®ä¿æ¸©æ¹¿åº¦å¡ç‰‡çš„èƒŒæ™¯é¢œè‰²ä¹Ÿè¢«é‡ç½® */
        const sensorCardElem = document.querySelector('.sensor-card');
        sensorCardElem.className = 'sensor-card flex-1 bg-gradient-to-br from-blue-500 to-green-500 rounded-xl p-3 flex flex-col justify-center items-center h-36 text-sm';

        console.log("ç½‘é¡µUIå·²æ¢å¤åˆ°åˆå§‹çŠ¶æ€ã€‚");
    }

    function sendDispatchCommand() {
        if (!client.isConnected()) {
            showFeedback("é”™è¯¯ï¼šæœªè¿æ¥åˆ°æœåŠ¡å™¨", true);
            return;
        }
        const selectedLocation = locations[currentLocationIndex];
        const payload = { command: 'dispatch_vehicle', location: selectedLocation.value };
        const message = new Paho.Message(JSON.stringify(payload));
        message.destinationName = MQTT_COMMAND_TOPIC;
        client.send(message);
        showFeedback(`â€œå‡ºåŠ¨å°è½¦â€æŒ‡ä»¤å·²å‘é€ (ç›®æ ‡: ${selectedLocation.name})ï¼`, false);
        addLogEntry({status_code: '0xa0'});
    }


    /**
     * âœï¸ BUGä¿®å¤ï¼šä¿®æ”¹æ­¤å‡½æ•°
     * åˆ‡æ¢åœ°ç‚¹æ—¶ï¼Œä¸ä»…æ›´æ–°UIï¼Œè¿˜è¦å‘K230å‘é€'set_location'æŒ‡ä»¤ï¼Œ
     * ä»¥åŒæ­¥è®¾å¤‡çš„é»˜è®¤å‡ºåŠ¨åœ°ç‚¹ã€‚
     */
    function switchLocation() {
        // 1. å¾ªç¯æ›´æ–°ç½‘é¡µæœ¬åœ°çš„åœ°ç‚¹ç´¢å¼•
        currentLocationIndex = (currentLocationIndex + 1) % locations.length;
        const newLocation = locations[currentLocationIndex];
        
        // 2. æ›´æ–°æŒ‰é’®çš„æ–‡æœ¬ï¼Œæä¾›å³æ—¶UIåé¦ˆ
        locationSwitchBtn.textContent = newLocation.name;
        showFeedback(`è‡ªåŠ¨å‡ºåŠ¨åœ°ç‚¹å·²åˆ‡æ¢ä¸º: ${newLocation.name}`, false);

        // 3. æ£€æŸ¥MQTTè¿æ¥
        if (!client.isConnected()) {
            showFeedback("é”™è¯¯ï¼šæœªè¿æ¥ï¼Œæ— æ³•åŒæ­¥åœ°ç‚¹åˆ°è®¾å¤‡", true);
            return; // å¦‚æœæœªè¿æ¥ï¼Œåˆ™ä¸æ‰§è¡Œå‘é€æ“ä½œ
        }

        // 4. å‘é€ 'set_location' æŒ‡ä»¤åˆ° K230
        const payload = { command: 'set_location', location: newLocation.value };
        const message = new Paho.Message(JSON.stringify(payload));
        message.destinationName = MQTT_COMMAND_TOPIC;
        client.send(message);
        
        console.log(`å·²å‘é€ 'set_location' æŒ‡ä»¤åˆ°è®¾å¤‡, ç›®æ ‡: ${newLocation.name} (${newLocation.value})`);
    }

    // --- äº‹ä»¶ç›‘å¬å™¨ç»‘å®š ---
    dispatchBtn.addEventListener('click', sendDispatchCommand);
    clearScreenBtn.addEventListener('click', resetUI);
    locationSwitchBtn.addEventListener('click', switchLocation);
    modeSwitchBtn.addEventListener('click', toggleDeviceMode);

    // --- è¿æ¥åˆ° MQTT æœåŠ¡å™¨ ---
    client.connect({ onSuccess: onConnect, onFailure: onFailure, useSSL: true, cleanSession: true });
</script>

</body>
</html>
